<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Orbit Control</title>
    <style>
        :root {
            --bg: #0d1117;
            --card: #161b22;
            --border: #30363d;
            --accent: #58a6ff;
            --text: #c9d1d9;
            --error: #f85149;
            --success: #3fb950;
            --warning: #d29922;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            min-height: 100vh;
        }
        .space-bg {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
            background: radial-gradient(ellipse at bottom, #1a1a2e 0%, #0d1117 100%);
        }
        .stars {
            position: absolute;
            width: 100%; height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #eee, transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, #fff, transparent);
            background-size: 300px 200px;
            animation: twinkle 4s ease-in-out infinite;
        }
        @keyframes twinkle { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .planet {
            position: fixed;
            border-radius: 50%;
            z-index: -1;
        }
        .planet1 {
            width: 60px; height: 60px;
            background: radial-gradient(circle at 30% 30%, #58a6ff, #1a4b8c);
            top: 8%; right: 5%;
            box-shadow: 0 0 30px rgba(88, 166, 255, 0.3);
        }
        .planet2 {
            width: 30px; height: 30px;
            background: radial-gradient(circle at 30% 30%, #3fb950, #1a5c28);
            bottom: 10%; right: 10%;
        }
        .app { min-height: 100vh; display: flex; flex-direction: column; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }
        .header h1 { font-size: 1.2rem; font-weight: 400; }
        .header h1 b { color: var(--accent); }
        .header-btns { display: flex; gap: 8px; }
        .btn {
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }
        .btn-primary { background: var(--accent); color: #0d1117; }
        .btn-danger { background: transparent; color: var(--error); border: 1px solid var(--border); }
        .btn-secondary { background: var(--card); color: var(--text); border: 1px solid var(--border); }
        .content { flex: 1; padding: 15px; overflow-y: auto; }
        .server-list { display: flex; flex-direction: column; gap: 10px; }
        .server-item {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }
        .server-item.offline { opacity: 0.6; }
        .status-dot {
            width: 12px; height: 12px;
            border-radius: 50%;
            background: var(--error);
            flex-shrink: 0;
        }
        .status-dot.online { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .server-details { flex: 1; }
        .server-name { font-weight: 600; font-size: 1rem; margin-bottom: 2px; }
        .server-ip { font-size: 0.75rem; color: #8b949e; font-family: monospace; }
        .server-ping { font-family: monospace; font-size: 0.85rem; color: var(--accent); }
        .server-arrow { color: #6e7681; font-size: 1.2rem; }
        .no-servers { text-align: center; padding: 60px 20px; }
        .no-servers h2 { font-size: 1.3rem; margin-bottom: 10px; }
        .no-servers p { color: #8b949e; margin-bottom: 20px; }
        .panel {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--bg);
            z-index: 100;
            flex-direction: column;
        }
        .panel.show { display: flex; }
        .panel-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }
        .back-btn {
            background: none;
            border: none;
            color: var(--accent);
            font-size: 1.5rem;
            cursor: pointer;
        }
        .panel-title { flex: 1; }
        .panel-title h2 { font-size: 1.1rem; font-weight: 600; }
        .panel-title span { font-size: 0.75rem; color: #8b949e; }
        .panel-status { width: 10px; height: 10px; border-radius: 50%; background: var(--error); }
        .panel-status.online { background: var(--success); box-shadow: 0 0 6px var(--success); }
        .panel-content { flex: 1; overflow-y: auto; padding: 15px; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
        }
        .stat-card.full { grid-column: span 2; }
        .stat-value { font-size: 2rem; font-weight: 700; }
        .stat-label { font-size: 0.7rem; color: #8b949e; text-transform: uppercase; margin-top: 5px; }
        .panel-actions { padding: 15px; border-top: 1px solid var(--border); }
        .detail-panel {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--bg);
            z-index: 200;
            flex-direction: column;
        }
        .detail-panel.show { display: flex; }
        .detail-list { display: flex; flex-direction: column; gap: 8px; }
        .detail-item {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
        }
        .detail-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .detail-name { font-weight: 600; font-size: 0.95rem; word-break: break-all; }
        .detail-status {
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .detail-status.running { background: rgba(63, 185, 80, 0.2); color: var(--success); }
        .detail-status.stopped { background: rgba(248, 81, 73, 0.2); color: var(--error); }
        .detail-status.paused { background: rgba(210, 153, 34, 0.2); color: var(--warning); }
        .detail-meta { font-size: 0.75rem; color: #8b949e; margin-bottom: 10px; word-break: break-all; }
        .detail-actions { display: flex; gap: 6px; flex-wrap: wrap; }
        .action-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            background: transparent;
            border-radius: 6px;
            font-size: 0.7rem;
            color: var(--text);
            cursor: pointer;
        }
        .action-btn.start { color: var(--success); border-color: var(--success); }
        .action-btn.stop { color: var(--error); border-color: var(--error); }
        .action-btn.restart { color: var(--warning); border-color: var(--warning); }
        .action-btn.logs { color: var(--accent); border-color: var(--accent); }
        .empty-state { text-align: center; padding: 40px; color: #8b949e; }
        .logs-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 300;
            flex-direction: column;
        }
        .logs-modal.show { display: flex; }
        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }
        .logs-title { font-weight: 600; }
        .logs-close { background: none; border: none; color: var(--text); font-size: 1.5rem; cursor: pointer; }
        .logs-content {
            flex: 1;
            overflow: auto;
            padding: 15px;
            font-family: monospace;
            font-size: 0.75rem;
            white-space: pre-wrap;
            background: #000;
            color: #0f0;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            justify-content: center;
            align-items: center;
            z-index: 400;
            padding: 20px;
        }
        .modal.show { display: flex; }
        .modal-box {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            width: 100%;
            max-width: 350px;
        }
        .modal-title { font-size: 1rem; font-weight: 600; margin-bottom: 15px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 0.75rem; color: #8b949e; margin-bottom: 4px; }
        .form-group input {
            width: 100%;
            padding: 10px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.9rem;
        }
        .form-group input:focus { outline: none; border-color: var(--accent); }
        .modal-btns { display: flex; gap: 10px; margin-top: 15px; }
        .modal-btns button { flex: 1; }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.85rem;
            display: none;
            z-index: 500;
        }
        .toast.show { display: block; }
        .toast.ok { border-color: var(--success); color: var(--success); }
        .toast.err { border-color: var(--error); color: var(--error); }
        .info-section {
            grid-column: span 2;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            margin-top: 5px;
        }
        .info-title {
            font-size: 0.7rem;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(48,54,61,0.5);
        }
        .info-row:last-child { border-bottom: none; }
        .info-val { font-weight: 600; }
        .text-green { color: var(--success); }
        .text-red { color: var(--error); }
        .mini-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 0.8rem;
        }
        .mini-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 4px var(--success);
        }
        .mini-more {
            font-size: 0.75rem;
            color: #8b949e;
            padding-top: 5px;
        }
    </style>
</head>
<body>
    <div class="space-bg"><div class="stars"></div></div>
    <div class="planet planet1"></div>
    <div class="planet planet2"></div>
    <div class="app">
        <div class="header">
            <h1>Orbit <b>Control</b></h1>
            <div class="header-btns">
                <button class="btn btn-primary" onclick="openAddModal()">+ Add</button>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>
        <div class="content">
            <div id="no-servers" class="no-servers" style="display:none;">
                <h2>Welcome!</h2>
                <p>Add your first server to get started</p>
                <button class="btn btn-primary" onclick="openAddModal()">+ Add Server</button>
            </div>
            <div class="server-list" id="server-list"></div>
        </div>
    </div>
    <div class="panel" id="server-panel">
        <div class="panel-header">
            <button class="back-btn" onclick="closePanel()">&larr;</button>
            <div class="panel-title">
                <h2 id="panel-name">Server</h2>
                <span id="panel-ip">0.0.0.0</span>
            </div>
            <div class="panel-status" id="panel-status"></div>
        </div>
        <div class="panel-content">
            <div class="stats-grid" id="stats-grid"></div>
        </div>
        <div class="panel-actions">
            <button class="btn btn-danger" style="width:100%" onclick="deleteCurrentServer()">Delete Server</button>
        </div>
    </div>
    <div class="detail-panel" id="detail-panel">
        <div class="panel-header">
            <button class="back-btn" onclick="closeDetail()">&larr;</button>
            <div class="panel-title">
                <h2 id="detail-title">Items</h2>
                <span id="detail-count">0 items</span>
            </div>
        </div>
        <div class="panel-content">
            <div class="detail-list" id="detail-list"></div>
        </div>
    </div>
    <div class="logs-modal" id="logs-modal">
        <div class="logs-header">
            <span class="logs-title" id="logs-title">Logs</span>
            <button class="logs-close" onclick="closeLogs()">&times;</button>
        </div>
        <div class="logs-content" id="logs-content">Loading...</div>
    </div>
    <div class="modal" id="add-modal">
        <div class="modal-box">
            <div class="modal-title">Add Server</div>
            <form id="add-form">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="srv-name" placeholder="My Server" required>
                </div>
                <div class="form-group">
                    <label>IP Address</label>
                    <input type="text" id="srv-ip" placeholder="192.168.1.100" required>
                </div>
                <div class="form-group">
                    <label>Port</label>
                    <input type="number" id="srv-port" value="5001">
                </div>
                <div class="modal-btns">
                    <button type="button" class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add</button>
                </div>
            </form>
        </div>
    </div>
    <div class="toast" id="toast"></div>
<script>
let servers=[], serverData={}, currentServer=null, currentType=null;

async function loadServers() {
    try {
        const res = await fetch('/api/servers');
        if (res.status === 401) return location.href = '/';
        servers = (await res.json()).servers || [];
        if (!servers.length) {
            document.getElementById('no-servers').style.display = 'block';
            document.getElementById('server-list').innerHTML = '';
            return;
        }
        document.getElementById('no-servers').style.display = 'none';
        for (const s of servers) {
            try {
                const r = await fetch('/api/server/' + s.id + '/stats');
                serverData[s.id] = await r.json();
            } catch(e) { serverData[s.id] = { connected: false }; }
        }
        renderServerList();
    } catch(e) { console.error(e); }
}

function renderServerList() {
    const list = document.getElementById('server-list');
    list.innerHTML = servers.map(s => {
        const d = serverData[s.id] || {};
        return '<div class="server-item '+(d.connected?'':'offline')+'" onclick="openPanel('+s.id+')">'+
            '<div class="status-dot '+(d.connected?'online':'')+'"></div>'+
            '<div class="server-details"><div class="server-name">'+s.name+'</div>'+
            '<div class="server-ip">'+s.ip+':'+s.port+'</div></div>'+
            '<div class="server-ping">'+(d.ping||'--')+'</div>'+
            '<div class="server-arrow">&rsaquo;</div></div>';
    }).join('');
}

function openPanel(serverId) {
    currentServer = servers.find(s => s.id === serverId);
    const d = serverData[serverId] || {};
    const c = d.counts || {};
    const containers = d.containers || [];
    const running = containers.filter(x => x.status === 'running');
    
    document.getElementById('panel-name').textContent = currentServer.name;
    document.getElementById('panel-ip').textContent = currentServer.ip + ':' + currentServer.port;
    document.getElementById('panel-status').className = 'panel-status ' + (d.connected ? 'online' : '');
    
    document.getElementById('stats-grid').innerHTML = 
        '<div class="stat-card" onclick="openDetail(\'containers\')"><div class="stat-value">'+(c.containers||0)+'</div><div class="stat-label">Containers</div></div>'+
        '<div class="stat-card" onclick="openDetail(\'images\')"><div class="stat-value">'+(c.images||0)+'</div><div class="stat-label">Images</div></div>'+
        '<div class="stat-card" onclick="openDetail(\'volumes\')"><div class="stat-value">'+(c.volumes||0)+'</div><div class="stat-label">Volumes</div></div>'+
        '<div class="stat-card" onclick="openDetail(\'networks\')"><div class="stat-value">'+(c.networks||0)+'</div><div class="stat-label">Networks</div></div>'+
        '<div class="stat-card full" onclick="openDetail(\'stacks\')"><div class="stat-value">'+(c.stacks||0)+'</div><div class="stat-label">Stacks</div></div>'+
        '<div class="info-section"><div class="info-title">Server Info</div>'+
        '<div class="info-row"><span>Ping</span><span class="info-val">'+(d.ping||'--')+'</span></div>'+
        '<div class="info-row"><span>Status</span><span class="info-val '+(d.connected?'text-green':'text-red')+'">'+(d.connected?'Online':'Offline')+'</span></div>'+
        '<div class="info-row"><span>Running</span><span class="info-val">'+running.length+' / '+containers.length+'</span></div></div>'+
        (running.length > 0 ? '<div class="info-section"><div class="info-title">Running Containers</div>'+
        running.slice(0,5).map(x => '<div class="mini-container"><span class="mini-dot"></span><span>'+x.name+'</span></div>').join('')+
        (running.length > 5 ? '<div class="mini-more">+' + (running.length - 5) + ' more...</div>' : '') + '</div>' : '');
    
    document.getElementById('server-panel').classList.add('show');
}

function closePanel() {
    document.getElementById('server-panel').classList.remove('show');
    currentServer = null;
}

async function deleteCurrentServer() {
    if (!currentServer || !confirm('Delete this server?')) return;
    await fetch('/api/servers/' + currentServer.id, {method: 'DELETE'});
    closePanel();
    toast('Server deleted', 'ok');
    loadServers();
}

async function openDetail(type) {
    currentType = type;
    const d = serverData[currentServer.id] || {};
    const items = d[type] || [];
    const titles = {containers:'Containers',images:'Images',volumes:'Volumes',networks:'Networks',stacks:'Stacks'};
    document.getElementById('detail-title').textContent = titles[type];
    document.getElementById('detail-count').textContent = items.length + ' items';
    renderDetailList(type, items);
    document.getElementById('detail-panel').classList.add('show');
}

function renderDetailList(type, items) {
    const list = document.getElementById('detail-list');
    if (!items.length) { list.innerHTML = '<div class="empty-state">No items found</div>'; return; }
    if (type === 'containers') {
        list.innerHTML = items.map(c => 
            '<div class="detail-item"><div class="detail-top"><span class="detail-name">'+c.name+'</span>'+
            '<span class="detail-status '+c.status+'">'+c.status+'</span></div>'+
            '<div class="detail-meta">'+c.image+'</div><div class="detail-actions">'+
            (c.status!=='running'?'<button class="action-btn start" onclick="containerAction(\''+c.id+'\',\'start\')">Start</button>':'')+
            (c.status==='running'?'<button class="action-btn stop" onclick="containerAction(\''+c.id+'\',\'stop\')">Stop</button>':'')+
            '<button class="action-btn restart" onclick="containerAction(\''+c.id+'\',\'restart\')">Restart</button>'+
            '<button class="action-btn logs" onclick="showLogs(\''+c.id+'\',\''+c.name+'\')">Logs</button></div></div>'
        ).join('');
    } else if (type === 'stacks') {
        list.innerHTML = items.map(s => {
            const running = (s.containers||[]).filter(c => c.status === 'running').length;
            const total = (s.containers||[]).length;
            const status = running === total && total > 0 ? 'running' : running > 0 ? 'paused' : 'stopped';
            return '<div class="detail-item"><div class="detail-top"><span class="detail-name">'+s.name+'</span>'+
                '<span class="detail-status '+status+'">'+running+'/'+total+'</span></div><div class="detail-actions">'+
                '<button class="action-btn start" onclick="stackAction(\''+s.name+'\',\'start\')">Start</button>'+
                '<button class="action-btn stop" onclick="stackAction(\''+s.name+'\',\'stop\')">Stop</button>'+
                '<button class="action-btn restart" onclick="stackAction(\''+s.name+'\',\'restart\')">Restart</button></div></div>';
        }).join('');
    } else if (type === 'images') {
        list.innerHTML = items.map(i => 
            '<div class="detail-item"><div class="detail-top"><span class="detail-name">'+(i.tags&&i.tags[0]||i.id)+'</span>'+
            '<span class="detail-status running">'+i.size+'</span></div><div class="detail-meta">ID: '+i.id+'</div></div>'
        ).join('');
    } else if (type === 'volumes') {
        list.innerHTML = items.map(v => 
            '<div class="detail-item"><div class="detail-top"><span class="detail-name">'+v.name+'</span></div>'+
            '<div class="detail-meta">'+v.driver+' - '+v.mountpoint+'</div></div>'
        ).join('');
    } else if (type === 'networks') {
        list.innerHTML = items.map(n => 
            '<div class="detail-item"><div class="detail-top"><span class="detail-name">'+n.name+'</span>'+
            '<span class="detail-status running">'+n.driver+'</span></div><div class="detail-meta">'+n.scope+' - '+n.id+'</div></div>'
        ).join('');
    }
}

function closeDetail() { document.getElementById('detail-panel').classList.remove('show'); }

async function containerAction(id, action) {
    toast(action + '...', 'ok');
    await fetch('/api/server/' + currentServer.id + '/container/' + id + '/' + action, {method:'POST'});
    toast('Done!', 'ok');
    setTimeout(async () => {
        const r = await fetch('/api/server/' + currentServer.id + '/stats');
        serverData[currentServer.id] = await r.json();
        openDetail('containers');
    }, 1500);
}

async function stackAction(name, action) {
    toast(action + '...', 'ok');
    await fetch('/api/server/' + currentServer.id + '/stack/' + name + '/' + action, {method:'POST'});
    toast('Done!', 'ok');
    setTimeout(async () => {
        const r = await fetch('/api/server/' + currentServer.id + '/stats');
        serverData[currentServer.id] = await r.json();
        openDetail('stacks');
    }, 2000);
}

async function showLogs(containerId, name) {
    document.getElementById('logs-title').textContent = 'Logs: ' + name;
    document.getElementById('logs-content').textContent = 'Loading...';
    document.getElementById('logs-modal').classList.add('show');
    try {
        const res = await fetch('/api/server/' + currentServer.id + '/container/' + containerId + '/logs');
        const data = await res.json();
        document.getElementById('logs-content').textContent = data.logs || 'No logs';
    } catch(e) { document.getElementById('logs-content').textContent = 'Failed to load logs'; }
}

function closeLogs() { document.getElementById('logs-modal').classList.remove('show'); }
function openAddModal() { document.getElementById('add-modal').classList.add('show'); }
function closeAddModal() { document.getElementById('add-modal').classList.remove('show'); }

document.getElementById('add-form').onsubmit = async (e) => {
    e.preventDefault();
    const fd = new FormData();
    fd.append('name', document.getElementById('srv-name').value);
    fd.append('ip', document.getElementById('srv-ip').value);
    fd.append('port', document.getElementById('srv-port').value || 5001);
    await fetch('/api/servers/add', {method:'POST', body:fd});
    closeAddModal();
    document.getElementById('srv-name').value = '';
    document.getElementById('srv-ip').value = '';
    toast('Server added!', 'ok');
    loadServers();
};

function toast(msg, type) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast show ' + type;
    setTimeout(() => t.classList.remove('show'), 2000);
}

function logout() { location.href = '/api/logout'; }

loadServers();
setInterval(loadServers, 10000);
</script>
</body>
</html>
